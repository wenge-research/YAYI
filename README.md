# é›…æ„å¤§æ¨¡å‹

<div align="center">
<img src="./assets/yayi_dark_small.png" alt="YaYi" style="width: 30%; display: block; margin: auto;">
<br>

[![Code License](https://img.shields.io/badge/Code%20License-Apache_2.0-brightgreen.svg)](./LICENSE)
[![Data License](https://img.shields.io/badge/Data%20License-CC_BY_NC_4.0-red.svg)](./LICENSE_DATA)
[![Model License](https://img.shields.io/badge/Model%20License-YaYi_7B-blue.svg)](./LICENSE_MODEL)
<!-- <a href="https://github.com/wenge-research/YaYi/stargazers">![GitHub Repo stars](https://img.shields.io/github/stars/wenge-research/YaYi?style=social)</a> -->

[[ğŸ“–README](./README.md)] 
[[ğŸ¤—HF Repo](https://huggingface.co/wenge-research)]
[[ğŸ”—ç½‘é¡µç«¯](https://yayi.wenge.com)]

</div>

## ä»‹ç»
[é›…æ„å¤§æ¨¡å‹](https://yayi.wenge.com) åœ¨ç™¾ä¸‡çº§äººå·¥æ„é€ çš„é«˜è´¨é‡é¢†åŸŸæ•°æ®ä¸Šè¿›è¡ŒæŒ‡ä»¤å¾®è°ƒå¾—åˆ°ï¼Œè®­ç»ƒæ•°æ®è¦†ç›–åª’ä½“å®£ä¼ ã€èˆ†æƒ…åˆ†æã€å…¬å…±å®‰å…¨ã€é‡‘èé£æ§ã€åŸå¸‚æ²»ç†ç­‰äº”å¤§é¢†åŸŸï¼Œä¸Šç™¾ç§è‡ªç„¶è¯­è¨€æŒ‡ä»¤ä»»åŠ¡ã€‚é›…æ„å¤§æ¨¡å‹ä»é¢„è®­ç»ƒåˆå§‹åŒ–æƒé‡åˆ°é¢†åŸŸæ¨¡å‹çš„è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€æ­¥å¢å¼ºäº†å®ƒçš„ä¸­æ–‡åŸºç¡€èƒ½åŠ›å’Œé¢†åŸŸåˆ†æèƒ½åŠ›ï¼Œå¹¶å¢åŠ äº†éƒ¨åˆ†æ’ä»¶èƒ½åŠ›ã€‚åŒæ—¶ï¼Œç»è¿‡æ•°ç™¾åç”¨æˆ·å†…æµ‹è¿‡ç¨‹ä¸­æŒç»­ä¸æ–­çš„äººå·¥åé¦ˆä¼˜åŒ–ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥æå‡äº†æ¨¡å‹æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚

é€šè¿‡é›…æ„å¤§æ¨¡å‹çš„å¼€æºä¸ºä¿ƒè¿›ä¸­æ–‡é¢„è®­ç»ƒå¤§æ¨¡å‹å¼€æºç¤¾åŒºçš„å‘å±•ï¼Œè´¡çŒ®è‡ªå·±çš„ä¸€ä»½åŠ›é‡ï¼Œé€šè¿‡å¼€æºï¼Œä¸æ¯ä¸€ä½åˆä½œä¼™ä¼´å…±å»ºé›…æ„å¤§æ¨¡å‹ç”Ÿæ€ã€‚

## è¿è¡Œæ–¹å¼

### ç¯å¢ƒå®‰è£…
1. ä¸‹è½½æœ¬ä»“åº“å†…å®¹è‡³æœ¬åœ°/è¿œç¨‹æœåŠ¡å™¨

```bash
git clone https://github.com/wenge-research/YaYi.git
cd YaYi
```

2. åˆ›å»ºcondaç¯å¢ƒ

```bash
conda create --name yayi python=3.8
conda activate yayi
```

3. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```
å…¶ä¸­ `torch` å’Œ `transformers` ç‰ˆæœ¬ä¸å»ºè®®ä½äºæ¨èç‰ˆæœ¬ã€‚

### æ¨¡å‹æ¨ç†

æ¨¡å‹æƒé‡ï¼ˆ7bç‰ˆæœ¬ï¼‰å·²åœ¨æˆ‘ä»¬çš„ [Huggingface æ¨¡å‹ä»“åº“](https://huggingface.co/wenge-research) å¼€æºï¼Œæ¬¢è¿ä¸‹è½½ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•è°ƒç”¨ `yayi-7b` è¿›è¡Œä¸‹æ¸¸ä»»åŠ¡æ¨ç†çš„ç¤ºä¾‹ä»£ç ï¼Œå¯åœ¨å•å¼  A100/A800/3090 ç­‰GPUè¿è¡Œï¼Œä½¿ç”¨FP16ç²¾åº¦æ¨ç†æ—¶çº¦å ç”¨ 20GB æ˜¾å­˜ï¼š

```python
from transformers import AutoTokenizer, AutoModelForCausalLM, GenerationConfig

yayi_7b_path = "wenge-research/yayi-7b"
tokenizer = AutoTokenizer.from_pretrained(yayi_7b_path)
model = AutoModelForCausalLM.from_pretrained(yayi_7b_path, device_map="auto", torch_dtype=torch.bfloat16)

prompt = "ä½ å¥½"
formatted_prompt = f"<|System|>:\nA chat between a human and an AI assistant named YaYi.\nYaYi is a helpful and harmless language model developed by Beijing Wenge Technology Co.,Ltd.\n\n<|Human|>:\n{prompt}\n\n<|YaYi|>:"
inputs = tokenizer.encode(prompt, return_tensors="pt").to(model.device)

generation_config = GenerationConfig(
    do_sample=True,
    max_new_tokens=100,
    temperature=0.3,
    repetition_penalty=1.1,
    no_repeat_ngram_size=0
)
response = model.generate(**inputs, generation_config=generation_config)
print(tokenizer.decode(outputs[0]))
```

æ³¨æ„ï¼Œæ¨¡å‹è®­ç»ƒæ—¶æ·»åŠ äº† special token `<|End|>` ä½œä¸ºç»“æŸç¬¦ï¼Œä¸Šè¿°ä»£ç åœ¨ç”Ÿæˆå¼è‹¥ä¸èƒ½è‡ªåŠ¨åœæ­¢ï¼Œå¯å®šä¹‰ `KeywordsStoppingCriteria` ç±»ï¼Œå¹¶å°†å…¶å¯¹è±¡ä¼ å‚è‡³ `model.generate()` å‡½æ•°ã€‚

```python
class KeywordsStoppingCriteria(StoppingCriteria):
    def __init__(self, keywords_ids:list):
        self.keywords = keywords_ids

    def __call__(self, input_ids: torch.LongTensor, scores: torch.FloatTensor, **kwargs) -> bool:
        if input_ids[0][-1] in self.keywords:
            return True
        return False
```

```python
stop_criteria = KeywordsStoppingCriteria([tokenizer.encode(w)[0] for w in ["<|End|>"]])
...
response = model.generate(**inputs, generation_config=generation_config, stop_criteria=stop_criteria)
```

### æ¨¡å‹å¾®è°ƒ

æœ¬é¡¹ç›®åŸºäº `deepspeed` æ¡†æ¶è¿›è¡Œæ¨¡å‹è®­ç»ƒï¼Œé…ç½®å®Œç¯å¢ƒåæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¡Œå³å¯å¼€å§‹æ¨¡å‹å¾®è°ƒï¼ˆå•æœºå¤šå¡ï¼‰ã€‚

```
deepspeed --num_gpus=8 \
    --module training.trainer \
    --data-path ./data/yayi_train_example.json \
    --input-model ./checkpoints/yayi-7b \
    --deepspeed ./config/deepspeed_zero2_bf16.json \
    --epochs 2 \
    --local-output-dir ./checkpoints \
    --per-device-train-batch-size 8 \
    --per-device-eval-batch-size 8 \
    --logging-steps 1 \
    --save-steps 100 \
    --save-total-limit 10 \
    --eval-steps 100 \
    --warmup-steps 100 \
    --test-size 400 \
    --lr 5e-7 \
    --seed 515
```


## è®­ç»ƒæ•°æ®

é›…æ„å¤§æ¨¡å‹åŸºäºä¸­ç§‘é—»æ­Œç™¾ä¸‡çº§é«˜è´¨é‡é¢†åŸŸæŒ‡ä»¤å¾®è°ƒæ•°æ®é›†è®­ç»ƒè€Œæ¥ï¼Œæˆ‘ä»¬æœ¬æ¬¡å¼€æº 5w æ¡è®­ç»ƒæ•°æ®é›†ï¼Œå¯åœ¨æˆ‘ä»¬çš„ [Huggingface æ•°æ®ä»“åº“](https://huggingface.co/wenge-research) ä¸‹è½½ã€‚æ•°æ®é›†ä¸»è¦æ¶µç›–äº†é‡‘èã€å®‰å…¨ã€èˆ†æƒ…ã€åª’ä½“ç­‰å‡ å¤§é¢†åŸŸï¼Œæˆ‘ä»¬ä¸ºå„é¢†åŸŸä»»åŠ¡å¤§éƒ¨åˆ†æŒ‡ä»¤æ•°æ®æ·»åŠ äº†ç¦»æ•£ prompt å‰ç¼€ï¼Œä»¥åŒºåˆ†å„é¢†åŸŸæ•°æ®ã€‚


## æ¨¡å‹è¯„æµ‹

è¯„æµ‹å›¢é˜Ÿé’ˆå¯¹é‡‘èã€å®‰å…¨ã€èˆ†æƒ…ã€åª’ä½“ç­‰å‡ å¤§é¢†åŸŸï¼Œä»¥åŠåŸºç¡€èƒ½åŠ›ï¼ˆä¸»è§‚é¢˜ã€å®¢è§‚é¢˜ï¼‰å¯¹é›…æ„å¤§æ¨¡å‹è¿›è¡Œäº†å…¨é¢è¯„æµ‹ã€‚å¯¹æ¯”æ¨¡å‹åŒ…æ‹¬ ChatGPTã€æ–‡å¿ƒä¸€è¨€ã€ChatGLM-6Bã€æ˜Ÿç«ã€MOSSã€Vicuna-7Bã€é€šä¹‰åƒé—®ã€‚

è¯„åˆ†æ ‡å‡†ï¼š		

- ä¸»è§‚é¢˜ï¼šè¯„åˆ†1-5åˆ†ï¼Œ1éå¸¸å·®ã€2è¾ƒå·®ã€3ä¸€èˆ¬ã€4è¾ƒå¥½ã€5éå¸¸å¥½ï¼›å…±3äººè¯„æµ‹ï¼Œå‡†ç¡®æ€§å¹³å‡åˆ†å–3äººå¹³å‡åˆ†ã€‚			
- å®¢è§‚é¢˜ï¼šå‡†ç¡®ç‡=æ­£ç¡®æ•°/æ€»æ•°				
								
ä»¥ä¸‹æ˜¯è¯„æµ‹ç»“æœã€‚


### é‡‘èé¢†åŸŸ

| æ¨¡å‹           | æ’å | å‡†ç¡®æ€§å¹³å‡åˆ† |
|--------------|----|---- | 
| YaYi-7B | 1  | 3.99   | 
| ChatGPT      | 2  | 3.65   | 
| æ–‡å¿ƒä¸€è¨€         | 3  | 3.40   |
| æ˜Ÿç«           | 4  | 3.13   | 
| ChatGLM-6B   | 5  | 3.08   | 
| MOSS         | 6  | 2.69   | 
| Vicuna-7B    | 7  | 2.39   | 
| é€šä¹‰åƒé—®         | 8  | 2.07   | 


### å®‰å…¨é¢†åŸŸ
| æ¨¡å‹       | æ’å | å‡†ç¡®æ€§å¹³å‡åˆ† | 
| ------------ | ---- | ------------ |
| ChatGPT      | 1    | 3.71         |
| YaYi-7B | 2    | 3.66         | 
| æ–‡å¿ƒä¸€è¨€ | 3    | 3.43         |
| ChatGLM-6B   | 4    | 3.35         | 
| MOSS         | 5    | 2.87         | 
| Vicuna-7B    | 6    | 2.47         | 
| æ˜Ÿç«       | 7    | 1.98         | 
| é€šä¹‰åƒé—® | 8    | 1.69         | 

### èˆ†æƒ…é¢†åŸŸ

| æ¨¡å‹       | æ’å | å‡†ç¡®æ€§å¹³å‡åˆ† | 
| ------------ | ---- | ------------ |
| YaYi-7B | 1    | 3.66         |
| ChatGPT      | 2    | 3.56         | 
| ChatGLM-6B   | 3    | 2.87         | 
| æ–‡å¿ƒä¸€è¨€ | 4    | 2.83         | 
| æ˜Ÿç«       | 5    | 2.63         |
| Vicuna-7B    | 6    | 2.61         |
| MOSS         | 7    | 2.60         | 
| é€šä¹‰åƒé—® | 8    | 1.75         |

### åª’ä½“é¢†åŸŸ

| æ¨¡å‹       | æ’å | å‡†ç¡®æ€§å¹³å‡åˆ† | 
| ------------ | ---- | ------------ |
| ChatGPT      | 1    | 3.78         | 
| YaYi-7B | 2    | 3.50         | 
| ChatGLM-6B   | 3    | 3.38         | 
| æ–‡å¿ƒä¸€è¨€ | 4    | 3.31         | 
| æ˜Ÿç«       | 5    | 3.22         | 
| Vicuna-7B    | 6    | 3.16         |
| MOSS         | 7    | 3.07         | 
| é€šä¹‰åƒé—® | 8    | 2.16         |

### åŸºç¡€èƒ½åŠ›-å®¢è§‚é¢˜
| æ¨¡å‹       | æ’å | å¹³å‡å‡†ç¡®ç‡ | çŸ¥è¯†é¢˜ | è¯­å¥ç†è§£é¢˜ | æ–‡å­¦é¢˜ | é€»è¾‘æ¨ç†é¢˜ | ä¸Šä¸‹æ–‡é˜…è¯» |
| ------------ | ---- | ---------- | ------ | ---------- | ------ | ---------- | ---------- |
| ChatGPT      | 1    | 0.72       | 0.91   | 0.80       | 0.44   | 0.00       | 0.40       |
| æ–‡å¿ƒä¸€è¨€ | 2    | 0.65       | 0.68   | 0.80       | 0.64   | 0.50       | 0.20       |
| æ˜Ÿç«       | 3    | 0.57       | 0.68   | 0.70       | 0.36   | 0.25       | 0.40       |
| ChatGLM-6B   | 4    | 0.40       | 0.42   | 0.60       | 0.28   | 0.50       | 0.20       |
| MOSS         | 5    | 0.36       | 0.35   | 0.40       | 0.36   | 0.25       | 0.40       |
| YaYi-7B | 6    | 0.33       | 0.32   | 0.50       | 0.32   | 0.25       | 0.20       |
| é€šä¹‰åƒé—® | 7    | 0.26       | 0.19   | 0.80       | 0.12   | 0.75       | 0.20       |
| Vicuna-7B    | 8    | 0.22       | 0.23   | 0.30       | 0.20   | 0.00       | 0.20       |

### åŸºç¡€èƒ½åŠ›-ä¸»è§‚é¢˜

| æ¨¡å‹       | æ’å | å‡†ç¡®æ€§å¹³å‡åˆ† | ç¿»è¯‘é¢˜ | è¯­å¥ç†è§£é¢˜ | æ–‡å­¦é¢˜ | é€»è¾‘æ¨ç†é¢˜ | ä¸Šä¸‹æ–‡é˜…è¯» | ç¼–ç¨‹é¢˜ | åè§æ€§ | è„è¯ä¾®è¾±  | è¿æ³•çŠ¯ç½ª | èº«ä½“ä¼¤å®³ | å¿ƒç†å¥åº· | è´¢äº§éšç§ | é“å¾·ä¼¦ç† | æŒ‡ä»¤æ”»å‡»ï¼ˆç›®æ ‡åŠ«æŒï¼‰ | promptæ³„æ¼ | ä¸å®‰å…¨çš„æŒ‡ä»¤ | åå‘è¯±å¯¼ |
| ------------ | ---- | ------------ | ------ | ---------- | ------ | ---------- | ---------- | ------ | ------ | --------- | -------- | -------- | -------- | -------- | -------- | -------------------- | ---------- | ------------ | -------- |
| ChatGPT      | 1    | 4.29         | 4.00   | 4.50       | 3.90   | 3.53       | 5.00       | 4.20   | 3.60   | 4.83      | 4.70     | 4.67     | 4.63     | 4.63     | 4.13     | 4.47                 | 4.43       | 4.70         | 3.00     |
| æ–‡å¿ƒä¸€è¨€ | 2    | 4.17         | 3.78   | 4.50       | 4.67   | 2.77       | 5.00       | 4.00   | 3.49   | 4.77      | 4.63     | 4.70     | 4.63     | 4.43     | 4.10     | 4.03                 | 4.17       | 4.33         | 2.87     |
| æ˜Ÿç«       | 3    | 4.07         | 3.39   | 3.67       | 3.87   | 3.13       | 5.00       | 4.13   | 3.11   | 4.67      | 4.40     | 4.47     | 4.37     | 4.57     | 4.00     | 4.50                 | 4.40       | 4.52         | 3.00     |
| é€šä¹‰åƒé—® | 4    | 3.80         | 3.78   | 3.67       | 3.33   | 5.00       | 5.00       | 3.87   | 2.56   | 2.93      | 3.60     | 3.83     | 4.37     | 4.17     | 3.53     | 3.60                 | 4.07       | 4.17         | 3.07     |
| ChatGLM-6B   | 5    | 3.60         | 3.22   | 4.17       | 3.13   | 1.93       | 1.00       | 4.00   | 3.25   | 3.90      | 4.23     | 4.60     | 4.50     | 4.40     | 4.30     | 2.80                 | 4.40       | 4.60         | 2.80     |
| YaYi-7B | 6    | 3.48         | 2.39   | 3.50       | 2.80   | 1.57       | 1.67       | 3.53   | 3.32   | 3.17      | 3.63     | 4.63     | 4.70     | 4.60     | 3.97     | 3.97                 | 4.50       | 4.10         | 3.20     |
| MOSS         | 7    | 3.34         | 2.11   | 1.00       | 2.20   | 2.73       | 1.00       | 3.00   | 2.75   | 4.77      | 4.57     | 4.70     | 4.47     | 4.33     | 4.10     | 3.53                 | 4.17       | 4.00         | 3.33     |
| Vicuna-7B    | 8    | 3.16         | 2.22   | 3.17       | 3.40   | 1.97       | 1.33       | 3.13   | 2.79   | 3.10      | 3.37     | 3.67     | 4.47     | 3.77     | 3.83     | 4.27                 | 3.17       | 3.57         | 2.53     |


## Todo
- 15B å‚æ•°æ¨¡å‹æŒ‡ä»¤å¾®è°ƒ
- å¤šè½®å¯¹è¯ã€é€»è¾‘æ¨ç†èƒ½åŠ›å¢å¼º
- æŠ€æœ¯æŠ¥å‘Šã€æ’ä»¶å·¥å…·ã€æ¨¡å‹èƒ½åŠ›è¯„æµ‹

## ç›¸å…³åè®®

### å±€é™æ€§
åŸºäºå½“å‰æ•°æ®å’ŒåŸºç¡€æ¨¡å‹è®­ç»ƒå¾—åˆ°çš„SFTæ¨¡å‹ï¼Œåœ¨æ•ˆæœä¸Šä»å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. åœ¨æ¶‰åŠäº‹å®æ€§çš„æŒ‡ä»¤ä¸Šå¯èƒ½ä¼šäº§ç”Ÿè¿èƒŒäº‹å®çš„é”™è¯¯å›ç­”ã€‚
2. å¯¹äºå…·å¤‡å±å®³æ€§çš„æŒ‡ä»¤æ— æ³•å¾ˆå¥½çš„é‰´åˆ«ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå±å®³æ€§è¨€è®ºã€‚
3. åœ¨ä¸€äº›æ¶‰åŠæ¨ç†ã€ä»£ç ã€å¤šè½®å¯¹è¯ç­‰åœºæ™¯ä¸‹æ¨¡å‹çš„èƒ½åŠ›ä»æœ‰å¾…æé«˜ã€‚

### å…è´£å£°æ˜

åŸºäºä»¥ä¸Šæ¨¡å‹å±€é™æ€§ï¼Œæˆ‘ä»¬è¦æ±‚å¼€å‘è€…ä»…å°†æˆ‘ä»¬å¼€æºçš„ä»£ç ã€æ•°æ®ã€æ¨¡å‹åŠåç»­ç”¨æ­¤é¡¹ç›®ç”Ÿæˆçš„è¡ç”Ÿç‰©ç”¨äºç ”ç©¶ç›®çš„ï¼Œä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œä»¥åŠå…¶ä»–ä¼šå¯¹ç¤¾ä¼šå¸¦æ¥å±å®³çš„ç”¨é€”ã€‚è¯·è°¨æ…é‰´åˆ«å’Œä½¿ç”¨é›…æ„å¤§æ¨¡å‹ç”Ÿæˆçš„å†…å®¹ï¼Œè¯·å‹¿å°†ç”Ÿæˆçš„æœ‰å®³å†…å®¹ä¼ æ’­è‡³äº’è”ç½‘ã€‚è‹¥äº§ç”Ÿä¸è‰¯åæœï¼Œç”±ä¼ æ’­è€…è‡ªè´Ÿã€‚

æœ¬é¡¹ç›®ä»…å¯åº”ç”¨äºç ”ç©¶ç›®çš„ï¼Œé¡¹ç›®å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•å› ä½¿ç”¨æœ¬é¡¹ç›®ï¼ˆåŒ…å«ä½†ä¸é™äºæ•°æ®ã€æ¨¡å‹ã€ä»£ç ç­‰ï¼‰å¯¼è‡´çš„å±å®³æˆ–æŸå¤±ã€‚è¯¦ç»†è¯·å‚è€ƒ[å…è´£å£°æ˜](DISCLAIMER)ã€‚

### å¼€æºåè®®

æœ¬é¡¹ç›®ä¸­çš„ä»£ç ä¾ç…§ [Apache-2.0](LICENSE) åè®®å¼€æºï¼Œæ•°æ®é‡‡ç”¨ [CC BY-NC 4.0](LICENSE_DATA) åè®®ï¼ŒYaYi ç³»åˆ—æ¨¡å‹æƒé‡çš„ä½¿ç”¨åˆ™éœ€è¦éµå¾ª [Model License](LICENSE_MODEL)ã€‚

## è‡´è°¢
- æœ¬é¡¹ç›®ä½¿ç”¨äº† BigScience çš„ [bloomz-7b-mt](https://huggingface.co/bigscience/bloomz-7b1-mt) æ¨¡å‹æƒé‡ä½œä¸ºåˆå§‹åŒ–æƒé‡ï¼Œå¹¶åŸºäºè¯è¡¨è¿›è¡Œæ‰©å±•ï¼›
- æœ¬é¡¹ç›®è®­ç»ƒä»£ç å‚è€ƒäº† Databricks çš„ [dolly](https://github.com/databrickslabs/dolly) é¡¹ç›®åŠ Huggingface [transformers](https://github.com/huggingface/transformers) åº“ï¼›
- æœ¬é¡¹ç›®åˆ†å¸ƒå¼è®­ç»ƒä½¿ç”¨äº† Microsoft çš„ [DeepSpeed](https://github.com/microsoft/deepspeed) åˆ†å¸ƒå¼è®­ç»ƒå·¥å…·åŠ Huggingface transformers æ–‡æ¡£ä¸­çš„ [ZeRO stage 2](https://huggingface.co/docs/transformers/main_classes/deepspeed#zero2-config) é…ç½®æ–‡ä»¶ï¼›

## Star History
[![Star History Chart](https://api.star-history.com/svg?repos=wenge-research/YaYi&type=Date)](https://star-history.com/#wenge-research/YaYi&Date)